<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Gi√°m s√°t ATS - Realtime Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

  <style>
    body {
      background-color: #000;
      color: #ffeb3b;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding: 10px;
      font-size: 1.3rem;
    }

    .align-reading p {
      display: flex;
      justify-content: space-between;
    }

    .phase-col {
      background: #111;
      color: #ffeb3b;
      border-radius: 0.5rem;
      padding: 0.5rem;
      font-size: 1.2rem;
    }

    .align-reading p {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .border {
      border: 1px solid #dee2e6 !important;
    }


    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px;
    }

    .card {
      border-radius: 0.75rem;
      box-shadow: 0 0.125rem 0.25rem rgba(255, 255, 0, 0.3);
      padding: 1rem;
      background-color: #000;
      color: #ffeb3b;
    }

    .phase-col p {
      margin: 0;
      font-size: 1.2rem;
      line-height: 1.3;
    }

    h4,
    h5,
    h6 {
      margin-bottom: 0.5rem;
      font-size: 1.4rem;
      color: #ffeb3b;
    }

    p {
      margin-bottom: 0.3rem;
      font-size: 1.2rem;
    }

    .control-buttons .btn {
      margin: 0.2rem;
      padding: 0.3rem 0.7rem;
      font-size: 0.85rem;
    }

    .ats-card {
      display: none;
    }

    .ats-card.active {
      display: block;
    }

    .small {
      font-size: 0.85rem;
    }

    .row.mb-3 .col.text-center {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .blink-red {
      animation: blinkRed 1s infinite;
    }

    .blink-green {
      animation: blinkGreen 1s infinite;
    }

    @keyframes blinkRed {

      0%,
      100% {
        color: red;
      }

      50% {
        color: black;
      }
    }

    @keyframes blinkGreen {

      0%,
      100% {
        color: green;
      }

      50% {
        color: black;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">

    <div class="row g-3">
      <!-- ATS 1 -->
      <div class="col-md-6 ats-card">
        <div class="card">
          <!-- <h5 class="text-primary">NGU·ªíN 1</h5> -->
          <h5 class="text-center bg-success text-white py-2 rounded">NGU·ªíN 1</h5>


          <h6 id="data-title-gen1" class="text-primary">Th√¥ng s·ªë</h6>
          <div id="data-container-gen1">
            <div class="row mb-2">
              <div class="col phase-col align-reading border border-secondary rounded p-2 me-2">
                <strong>Pha A</strong>
                <p>UAB: <span id="gen1-uab">-</span></p>
                <p>UA: <span id="gen1-ua">-</span></p>
                <p>G√≥c pha: <span id="gen1-phaA">-</span></p>
              </div>
              <div class="col phase-col align-reading border border-secondary rounded p-2 me-2">
                <strong>Pha B</strong>
                <p>UBC: <span id="gen1-ubc">-</span></p>
                <p>UB: <span id="gen1-ub">-</span></p>
                <p>G√≥c pha: <span id="gen1-phaB">-</span></p>
              </div>
              <div class="col phase-col align-reading border border-secondary rounded p-2">
                <strong>Pha C</strong>
                <p>UCA: <span id="gen1-uca">-</span></p>
                <p>UC: <span id="gen1-uc">-</span></p>
                <p>G√≥c pha: <span id="gen1-phaC">-</span></p>
              </div>
            </div>

            <p>T·∫ßn s·ªë: <span id="gen1-freq">-</span> Hz</p>
          </div>

          <h6 class="text-primary">Th√¥ng s·ªë d√≤ng ƒëi·ªán t·ªïng ATS 1</h6>
          <div class="row mb-2">
            <div class="col phase-col border border-secondary rounded p-2 me-2">
              <strong>Pha A</strong>
              <p>D√≤ng ƒëi·ªán pha A: <span id="gen1-ia">-</span> A</p>
            </div>
            <div class="col phase-col border border-secondary rounded p-2 me-2">
              <strong>Pha B</strong>
              <p>D√≤ng ƒëi·ªán pha B: <span id="gen1-ib">-</span> A</p>
            </div>
            <div class="col phase-col border border-secondary rounded p-2">
              <strong>Pha C</strong>
              <p>D√≤ng ƒëi·ªán pha C: <span id="gen1-ic">-</span> A</p>
            </div>
          </div>

          <canvas id="chart-gen1" height="220"></canvas>
          <p class="text-muted small">C·∫≠p nh·∫≠t: <span id="updated-time-gen1">-</span></p>

          <div class="control-buttons text-center">
            <div class="mb-2">
              <div id="flash-message-1" class="text-center fw-bold mb-2" style="display:none;"></div>
              <button id="mode-status-1" class="btn btn-outline-dark" onclick="toggleMode(1)">Ch·∫ø ƒë·ªô: --</button>
            </div>
            <button class="btn btn-outline-success" onclick="sendControl(1, 'auto_on')">Chuy·ªÉn AUTO</button>
            <button class="btn btn-outline-danger" onclick="sendControl(1, 'auto_off')">Chuy·ªÉn MANUAL</button>
            <button class="btn btn-primary" onclick="sendControl(1, 'start')">Kh·ªüi ƒë·ªông</button>
            <button class="btn btn-danger" onclick="sendControl(1, 'stop')">T·∫Øt</button>
            <button id="btn-close-a-1" class="btn btn-success" onclick="sendControl(1, 'close_a')">ƒê√≥ng A</button>
            <button id="btn-open-1" class="btn btn-warning" onclick="sendControl(1, 'open')">C·∫Øt ƒëi·ªán</button>
            <button id="btn-close-b-1" class="btn btn-success" onclick="sendControl(1, 'close_b')">ƒê√≥ng B</button>

          </div>
          <!-- <div class="text-center text-danger fw-bold mt-1" id="status1"></div> -->

        </div>
      </div>


      <!-- ATS 2 -->
      <div class="col-md-6 ats-card">
        <div class="card">
          <!-- <h5 class="text-primary">NGU·ªíN 2</h5> -->
          <h5 class="text-center bg-success text-white py-2 rounded">NGU·ªíN 2</h5>

          <h6 id="data-title-gen2" class="text-primary">Th√¥ng s·ªë</h6>
          <div id="data-container-gen2">
            <div class="row mb-2">
              <div class="col phase-col align-reading border border-secondary rounded p-2 me-2">
                <strong>Pha A</strong>
                <p>UAB: <span id="gen2-uab">-</span></p>
                <p>UA: <span id="gen2-ua">-</span></p>
                <p>G√≥c pha: <span id="gen2-phaA">-</span></p>
              </div>
              <div class="col phase-col align-reading border border-secondary rounded p-2 me-2">
                <strong>Pha B</strong>
                <p>UBC: <span id="gen2-ubc">-</span></p>
                <p>UB: <span id="gen2-ub">-</span></p>
                <p>G√≥c pha: <span id="gen2-phaB">-</span></p>
              </div>
              <div class="col phase-col align-reading border border-secondary rounded p-2">
                <strong>Pha C</strong>
                <p>UCA: <span id="gen2-uca">-</span></p>
                <p>UC: <span id="gen2-uc">-</span></p>
                <p>G√≥c pha: <span id="gen2-phaC">-</span></p>
              </div>
            </div>

            <p>T·∫ßn s·ªë: <span id="gen2-freq">-</span> Hz</p>
          </div>
          <h6 class="text-primary">Th√¥ng s·ªë d√≤ng ƒëi·ªán t·ªïng ATS 2</h6>
          <div class="row mb-2">
            <div class="col phase-col align-reading border border-secondary rounded p-2 me-2">
              <strong>Pha A</strong>
              <p>D√≤ng ƒëi·ªán pha A: <span id="gen2-ia">-</span> A</p>
            </div>
            <div class="col phase-col align-reading border border-secondary rounded p-2 me-2">
              <strong>Pha B</strong>
              <p>D√≤ng ƒëi·ªán pha B: <span id="gen2-ib">-</span> A</p>
            </div>
            <div class="col phase-col align-reading border border-secondary rounded p-2">
              <strong>Pha C</strong>
              <p>D√≤ng ƒëi·ªán pha C: <span id="gen2-ic">-</span> A</p>
            </div>
          </div>

          <canvas id="chart-gen2" height="220"></canvas>
          <p class="text-muted small">C·∫≠p nh·∫≠t: <span id="updated-time-gen2">-</span></p>
          <!-- test bi·ªÉu ƒë·ªì -->
          <!-- Bi·ªÉu ƒë·ªì l·ªãch s·ª≠ ATS cho gen1 v√† gen2 -->

          <!-- end -->
          <div class="control-buttons text-center">
            <div id="flash-message-2" class="text-center fw-bold mb-2" style="display:none;"></div>
            <div class="mb-2">
              <button id="mode-status-2" class="btn btn-outline-dark" onclick="toggleMode(2)">Ch·∫ø ƒë·ªô: --</button>
            </div>
            <button class="btn btn-outline-success" onclick="sendControl(2, 'auto_on')">Chuy·ªÉn AUTO</button>
            <button class="btn btn-outline-danger" onclick="sendControl(2, 'auto_off')">Chuy·ªÉn MANUAL</button>
            <button class="btn btn-primary" onclick="sendControl(2, 'start')">Kh·ªüi ƒë·ªông</button>
            <button class="btn btn-danger" onclick="sendControl(2, 'stop')">T·∫Øt</button>
            <button id="btn-close-a-2" class="btn btn-success" onclick="sendControl(2, 'close_a')">ƒê√≥ng A</button>
            <button id="btn-open-2" class="btn btn-warning" onclick="sendControl(2, 'open')">C·∫Øt ƒëi·ªán</button>
            <button id="btn-close-b-2" class="btn btn-success" onclick="sendControl(2, 'close_b')">ƒê√≥ng B</button>

          </div>
          <!-- <div class="text-center text-danger fw-bold mt-1" id="status2"></div> -->
        </div>
      </div>
    </div>

    <!-- HTML -->
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <h5 class="text-primary">Bi·ªÉu ƒë·ªì d√≤ng ƒëi·ªán</h5>

          <div class="row mb-3">
            <div class="col-md-4">
              <label for="genSelect" class="form-label">Ch·ªçn ngu·ªìn:</label>
              <select id="genSelect" class="form-select">
                <option value="1" selected>NGU·ªíN 1</option>
                <option value="2">NGU·ªíN 2</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="rangeSelect" class="form-label">Kho·∫£ng th·ªùi gian:</label>
              <select id="rangeSelect" class="form-select">
                <option value="1h">1 Gi·ªù</option>
                <option value="3h">3 Gi·ªù</option>
                <option value="6h">6 Gi·ªù</option>
                <option value="9h">9 Gi·ªù</option>
                <option value="12h">12 Gi·ªù</option>
                <option value="24h" selected>24 Gi·ªù</option>
              </select>
            </div>

          </div>

          <canvas id="chart-history-ats" height="340"></canvas>
        </div>
      </div>
    </div>
    <script>
      const historyChart = new Chart(document.getElementById("chart-history-ats").getContext("2d"), {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Pha A",
              data: [],
              borderColor: "red",
              backgroundColor: "rgba(255,0,0,0.1)",
              fill: false,
              tension: 0.3,
              pointRadius: 3,
              pointHoverRadius: 6
            },
            {
              label: "Pha B",
              data: [],
              borderColor: "green",
              backgroundColor: "rgba(0,128,0,0.1)",
              fill: false,
              tension: 0.3,
              pointRadius: 3,
              pointHoverRadius: 6
            },
            {
              label: "Pha C",
              data: [],
              borderColor: "blue",
              backgroundColor: "rgba(0,0,255,0.1)",
              fill: false,
              tension: 0.3,
              pointRadius: 3,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          animation: true,
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'HH:mm dd/MM/yyyy',
                displayFormats: {
                  minute: 'HH:mm',
                  hour: 'HH:mm',
                  day: 'dd/MM',
                  month: 'MM/yyyy',
                  year: 'yyyy'
                }
              },
              title: { display: true, text: "Th·ªùi gian" },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 20
              }
            },
            y: {
              title: { display: true, text: "D√≤ng ƒëi·ªán (A)" },
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              labels: {
                usePointStyle: true,
                boxWidth: 10
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });


      function loadHistoryRange(genId = 1, range = "1d") {
        fetch(`/api/ats/history/${genId}?range=${range}`)
          .then(res => res.json())
          .then(data => {
            // Chuy·ªÉn UTC sang gi·ªù VN (+7) v√† ƒë·ªãnh d·∫°ng
            historyChart.data.labels = data.map(d => new Date(d.time));
            historyChart.data.datasets[0].data = data.map(d => d.ia);
            historyChart.data.datasets[1].data = data.map(d => d.ib);
            historyChart.data.datasets[2].data = data.map(d => d.ic);
            historyChart.update();
          })
          .catch(err => console.error("L·ªói khi t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠:", err));
      }

      // M·∫∑c ƒë·ªãnh t·∫£i ATS 1 trong 1 ng√†y
      loadHistoryRange(1, "1d");

      document.getElementById("rangeSelect").addEventListener("change", () => {
        const genId = document.getElementById("genSelect").value;
        const range = document.getElementById("rangeSelect").value;
        loadHistoryRange(genId, range);
      });

      document.getElementById("genSelect").addEventListener("change", () => {
        const genId = document.getElementById("genSelect").value;
        const range = document.getElementById("rangeSelect").value;
        loadHistoryRange(genId, range);
      });
    </script>
    <!-- end test -->

    <!-- test s·ªë n∆∞·ªõc -->
    <div class="card">
      <div class="card-header">S·ªë n∆∞·ªõc ƒëo ƒë∆∞·ª£c</div>
      <div class="card-body">
        <p><strong>Flow Rate:</strong> <span id="flowRate">--</span></p>
        <p><strong>Forward Flow:</strong> <span id="forwardFlow">--</span></p>
        <p><strong>Reverse Flow:</strong> <span id="reverseFlow">--</span></p> <!-- üëà Th√™m d√≤ng n√†y -->
      </div>
    </div>

    <!-- V√πng hi·ªÉn th·ªã ch·ªâ s·ªë SELEC -->
    <div class="card mt-3">
      <div class="card-header">Ch·ªâ s·ªë SELEC</div>
      <div class="card-body">
        <p><strong>SELEC 1:</strong> <span id="selec1">--</span></p>
        <p><strong>SELEC 2:</strong> <span id="selec2">--</span></p>
      </div>
    </div>

    <div class="row mb-3">
      <a href="{{ url_for('Home') }}" class="btn btn-secondary">Back to Dashboard</a>
      <!-- B·ªï sung HTML hi·ªÉn th·ªã s·ªë l∆∞·ª£ng client trong th·∫ª ti√™u ƒë·ªÅ -->
      <div class="col text-center">
        <h4><i class="fas fa-bolt"></i> Gi√°m s√°t ngu·ªìn ƒëi·ªán Farm TN4 Realtime
          <span id="client-count" class="badge bg-primary ms-2">0 clients</span>
        </h4>
      </div>
      <!-- test -->
    </div>


  </div>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io("{{ SOCKET_SERVER_URL }}");
  </script>
  <!-- ƒêo·∫°n script socket.io ƒë·ªÉ nh·∫≠n client count -->
  <script>
    socket.on("connect", () => {
      console.log("‚úÖ Socket.IO connected:", socket.id);
    });

    socket.on("connect_error", (err) => {
      console.error("‚ùå Socket.IO connection error:", err);
    });
    // ‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng client
    socket.on("client_count", (count) => {
      const el = document.getElementById("client-count");
      if (el) {
        el.textContent = `${count} client${count > 1 ? 's' : ''}`;
      }
    });

    socket.on("ats_data", (data) => {
      console.log("üì¶ Nh·∫≠n t·ª´ socket:", data);
      updateData("gen1", data.gen1);
      updateData("gen2", data.gen2);
      const sel1El = document.getElementById("selec1");
      const sel2El = document.getElementById("selec2");
      if (sel1El && typeof data.selec1 !== "undefined") sel1El.textContent = data.selec1;
      if (sel2El && typeof data.selec2 !== "undefined") sel2El.textContent = data.selec2;
      updateChart(chartGen1, data.gen1.ia, data.gen1.ib, data.gen1.ic);
      updateChart(chartGen2, data.gen2.ia, data.gen2.ib, data.gen2.ic);
      const now = new Date().toLocaleTimeString('vi-VN', { hour12: false });
      document.getElementById("updated-time-gen1").textContent = now;
      document.getElementById("updated-time-gen2").textContent = now;
    });
    // ‚úÖ Nh·∫≠n d·ªØ li·ªáu n∆∞·ªõc
    socket.on("water_data", function (data) {
      console.log("üì• D·ªØ li·ªáu n∆∞·ªõc:", data);
      const flowRateEl = document.getElementById("flowRate");
      const forwardEl = document.getElementById("forwardFlow");
      const reverseEl = document.getElementById("reverseFlow");

      if (flowRateEl) flowRateEl.innerText = data.FlowRate + " m¬≥/h";
      if (forwardEl) forwardEl.innerText = data.ForwardFlow + " m¬≥";
      if (reverseEl) reverseEl.innerText = data.ReverseTotalFlow + " m¬≥";
    });

    socket.on("flash_message", ({ id, message, color }) => {
      showFlashMessage(id, message, color);
    });


    const chartGen1 = createCurrentChart("chart-gen1");
    const chartGen2 = createCurrentChart("chart-gen2");

    const cards = document.querySelectorAll('.ats-card');
    let cardIndex = 0;
    function showCard(idx) {
      cards.forEach((c, i) => c.classList.toggle('active', i === idx));
    }
    if (cards.length) {
      showCard(0);
      setInterval(() => {
        cardIndex = (cardIndex + 1) % cards.length;
        showCard(cardIndex);
      }, 5000);
    }



    function displayPhase(val) {
      return val >= 3276.5 ? "-" : val.toFixed(1) + "¬∞";
    }

    function displayFreq(val) {
      return val <= 0.1 ? "-" : val.toFixed(2);
    }

    function updateData(prefix, data) {
      const useGrid = displayFreq(data.freq1) !== "-";
      const idx = prefix === 'gen1' ? '1' : '2';
      const suffix = useGrid ? '1' : '2';
      const title = document.getElementById(`data-title-${prefix}`);
      if (title) {
        title.textContent = useGrid ? `Th√¥ng s·ªë ƒëi·ªán l∆∞·ªõi ATS ${idx}` : `Th√¥ng s·ªë m√°y ph√°t ${idx}`;
      }
      const fields = ['uab', 'ua', 'ubc', 'ub', 'uca', 'uc', 'phaA', 'phaB', 'phaC', 'freq'];
      fields.forEach(key => {
        const el = document.getElementById(`${prefix}-${key}`);
        if (!el) return;
        const val = data[`${key}${suffix}`];
        const current = parseFloat(el.textContent);
        const newValue = key.startsWith('pha') ? displayPhase(val) :
          (key === 'freq') ? displayFreq(val) : parseFloat(val).toFixed(1);

        if (!isNaN(current) && !isNaN(parseFloat(newValue))) {
          if (parseFloat(newValue) > current) {
            el.style.color = 'red';
          } else if (parseFloat(newValue) < current) {
            el.style.color = 'green';
          } else {
            el.style.color = '#ffeb3b';
          }
        }

        if (typeof setBlinkingStyle === 'function') {
          setBlinkingStyle(el, newValue, current, key);
        }

        el.textContent = newValue;
      });

      ['ia', 'ib', 'ic'].forEach(key => {
        const el = document.getElementById(`${prefix}-${key}`);
        if (el && typeof data[key] !== 'undefined') {
          el.textContent = parseFloat(data[key]).toFixed(1);
        }
      });

      // ‚úÖ C·∫≠p nh·∫≠t ch·∫ø ƒë·ªô AUTO/MAN n·∫øu c√≥
      const modeEl = document.getElementById(`mode-status-${prefix === 'gen1' ? '1' : '2'}`);
      if (modeEl && typeof data.auto_mode !== "undefined") {
        const text = data.auto_mode ? "T·ª± ƒë·ªông (AUTO)" : "Th·ªß c√¥ng (MAN)";
        modeEl.textContent = `Ch·∫ø ƒë·ªô: ${text}`;
        modeEl.classList.remove("btn-outline-danger", "btn-outline-success");
        modeEl.classList.add(data.auto_mode ? "btn-outline-success" : "btn-outline-danger");
      }
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒëi·ªÅu khi·ªÉn ngu·ªìn A/B
      if (prefix === "gen1") {
        const btnA = document.getElementById("btn-close-a-1");
        const btnB = document.getElementById("btn-close-b-1");
        const btnOpen = document.getElementById("btn-open-1");

        if (btnA) {
          btnA.classList.remove("btn-outline-success", "btn-success");
          btnA.classList.add(data.status_close_a ? "btn-success" : "btn-outline-success");
        }

        if (btnB) {
          btnB.classList.remove("btn-outline-success", "btn-success");
          btnB.classList.add(data.status_close_b ? "btn-success" : "btn-outline-success");
        }

        if (btnOpen) {
          btnOpen.classList.remove("btn-outline-warning", "btn-warning");
          btnOpen.classList.add(data.status_open ? "btn-warning" : "btn-outline-warning");
        }
      }

      if (prefix === "gen2") {
        const btnA = document.getElementById("btn-close-a-2");
        const btnB = document.getElementById("btn-close-b-2");
        const btnOpen = document.getElementById("btn-open-2");

        if (btnA) {
          btnA.classList.remove("btn-outline-success", "btn-success");
          btnA.classList.add(data.status_close_a ? "btn-success" : "btn-outline-success");
        }

        if (btnB) {
          btnB.classList.remove("btn-outline-success", "btn-success");
          btnB.classList.add(data.status_close_b ? "btn-success" : "btn-outline-success");
        }

        if (btnOpen) {
          btnOpen.classList.remove("btn-outline-warning", "btn-warning");
          btnOpen.classList.add(data.status_open ? "btn-warning" : "btn-outline-warning");
        }
      }


    }



    function sendControl(id, action) {
      const actionText = {
        "start": "Kh·ªüi ƒë·ªông m√°y ph√°t",
        "stop": "T·∫Øt m√°y ph√°t",
        "auto_on": "Chuy·ªÉn sang ch·∫ø ƒë·ªô AUTO",
        "auto_off": "Chuy·ªÉn sang ch·∫ø ƒë·ªô MANUAL",
        "acb_on": "ƒê√≥ng ACB",
        "acb_off": "Ng·∫Øt ACB"
      };
      const confirmMessage = `X√°c nh·∫≠n: ${actionText[action] || action} cho ATS ${id}?`;

      if (!confirm(confirmMessage)) {
        return; // H·ªßy n·∫øu ng∆∞·ªùi d√πng kh√¥ng x√°c nh·∫≠n
      }

      fetch('/api/modbus/control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ generatorId: id, action })
      })
        .then(res => res.json().then(data => ({ status: res.status, body: data })))
        .then(({ status, body }) => {
          if (status === 401) {
            alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëi·ªÅu khi·ªÉn!");
            window.location.href = "/login";
          } else if (status === 403) {
            alert("B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y!");
          } else {
            // G·ªçi flash message
            showFlashMessage(id, body.message || 'ƒê√£ g·ª≠i l·ªánh', 'green');
          }
        })
        .catch(() => {
          document.getElementById(`status${id}`).textContent = 'L·ªói g·ª≠i l·ªánh';
        });
    }
    function showFlashMessage(id, message, color = 'blue') {
      const flash = document.getElementById(`flash-message-${id}`);
      if (!flash) return;

      flash.textContent = message;
      flash.style.display = 'block';
      flash.style.color = color;

      let blinkCount = 0;
      const maxBlinks = 6; // 3 l·∫ßn nh·∫•p nh√°y = 6 b∆∞·ªõc (·∫©n/hi·ªán)

      const interval = setInterval(() => {
        flash.style.visibility = (flash.style.visibility === 'hidden') ? 'visible' : 'hidden';
        blinkCount++;
        if (blinkCount >= maxBlinks) {
          clearInterval(interval);
          flash.style.display = 'none';
          flash.style.visibility = 'visible';
        }
      }, 2500); // üëà 2.5 gi√¢y m·ªói b∆∞·ªõc => 15 gi√¢y t·ªïng
    }




    function showGlobalAlert(message, color = 'orange') {
      const alert = document.getElementById("global-alert");
      alert.textContent = message;
      alert.style.backgroundColor = color;
      alert.style.display = "block";

      let blinkCount = 0;
      const maxBlinks = 6;

      const interval = setInterval(() => {
        alert.style.visibility = (alert.style.visibility === 'hidden') ? 'visible' : 'hidden';
        blinkCount++;
        if (blinkCount >= maxBlinks) {
          clearInterval(interval);
          alert.style.display = "none";
          alert.style.visibility = 'visible';
        }
      }, 300);
    }






    function createCurrentChart(canvasId) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            { label: "Pha A", data: [], borderWidth: 1, borderColor: 'red' },
            { label: "Pha B", data: [], borderWidth: 1, borderColor: 'green' },
            { label: "Pha C", data: [], borderWidth: 1, borderColor: 'blue' }
          ]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { ticks: { maxTicksLimit: 5 } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updateChart(chart, ia, ib, ic) {
      const now = new Date().toLocaleTimeString('vi-VN', { hour12: false });
      const data = chart.data;
      data.labels.push(now);
      data.datasets[0].data.push(ia);
      data.datasets[1].data.push(ib);
      data.datasets[2].data.push(ic);
      if (data.labels.length > 10) {
        data.labels.shift();
        data.datasets.forEach(ds => ds.data.shift());
      }
      chart.update();
    }
  </script>
  <script>
    function setBlinkingStyle(el, newValue, oldValue, type = "") {
      el.classList.remove("blink-red", "blink-green");

      const val = parseFloat(newValue);
      const prev = parseFloat(oldValue);

      if (isNaN(val)) return;

      if (["uab", "ubc", "uca"].some(k => el.id.includes(k))) {
        if (val > 380) el.classList.add("blink-red");
        else if (val < 380) el.classList.add("blink-green");
      } else if (["ua", "ub", "uc"].some(k => el.id.includes(k))) {
        if (val > 220) el.classList.add("blink-red");
        else if (val < 220) el.classList.add("blink-green");
      } else if (el.id.includes("freq")) {
        if (val > 50) el.classList.add("blink-red");
        else if (val < 50) el.classList.add("blink-green");
      } else if (el.id.includes("phaB") && val > 120) {
        el.classList.add("blink-red");
      } else if (el.id.includes("phaB") && val < 120) {
        el.classList.add("blink-green");
      } else if (el.id.includes("phaC") && val > 240) {
        el.classList.add("blink-red");
      } else if (el.id.includes("phaC") && val < 240) {
        el.classList.add("blink-green");
      } else if (["ia", "ib", "ic"].some(k => el.id.endsWith(k))) {
        if (val > prev) el.classList.add("blink-red");
        else if (val < prev) el.classList.add("blink-green");
      }
    }


  </script>
  <div id="global-alert" style="
  display: none;
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 24px;
  background-color: orange;
  color: white;
  font-weight: bold;
  font-size: 16px;
  border-radius: 8px;
  z-index: 9999;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
"></div>
</body>

</html>